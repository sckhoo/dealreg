const mysql = require('mysql');
const bodyParser = require('body-parser');

const app = express();

app.set('view engine', 'ejs');
app.use(express.static('public'));
app.use(bodyParser.urlencoded({extended: false}));

var con = mysql.createConnection({
    host: "calculator-mariadb",
    user: "root",
    password: "calculator-secret",
    database: "dealRegistration"
})

con.connect(function(err) {
    if (err) throw err;
    app.listen(3000, function(req, res) {
        console.log('listening to port 3000');
    })
})

app.get('/', function(req, res) {
    res.render('index');
})

app.get('/thanks', function(req, res) {
    res.render('thanks');
})

app.post('/thanks', function(req, res) {
    res.redirect('/thanks');

    var dealRegNo = req.body.dealRegNo;
    var oppName = req.body.oppName;
    var custName = req.body.custName;
    var country = req.body.country;
    var state = req.body.state;
    var totalEmployee = req.body.totalEmployee;
    var closeDate = req.body.closeDate;
    var reseller = req.body.reseller;
    var dealSubmitter = req.body.dealSubmitter;
    var revenue = req.body.revenue;

    var sql = `INSERT INTO `

    con.query(sql, function(err, result) {
        if (err) throw err;
    })

})

app.get('/login', function(req, res) {
    res.render('login');
})

var userName;

app.post('/login', function(req, res) {
    var username = req.body.username;
    var password = req.body.password;

    var pass = 'hello';
            
    if (password == pass) {
        userName = username;
        res.redirect('/admin');
        return userName;
    } else {
        res.render('incorrect');
    }
})

app.get('/admin', (req, res) => {
    res.render('admin', {user: userName});
})

app.get('/register', function(req, res) {
    res.render('register');
})

app.post('/register', function(req, res) {
    var username = req.body.username;
    var fname = req.body.fname;
    var lname = req.body.lname;
    var password = req.body.password;
    var cpassword = req.body.cPassword;
    var email = req.body.email;

    if (password == cpassword) {
        var sql = `INSERT INTO Admin (username, fname, lname, password, email) VALUE ('${username}', '${fname}', '${lname}', '${password}', '${email}')`
        con.query(sql, function(err, result) {
            if (err) throw err;
        })
    } else {
        res.render('wrongPass');
    }
})

app.get('/smtg', function(req, res) {
    res.send('hello');
})
